<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ç‚¹æ¤œçµæœå ±å‘Šã‚¢ãƒ—ãƒªï¼ˆiOSå¯¾å¿œãƒ»å¹´ã‚³ãƒ¼ãƒ‰é€£å‹•ï¼‰</title>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    :root { --brand:#007bff; --ok:#28a745; --danger:#e55353; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f5f6f8;text-align:center;padding:16px}
    h1{margin:8px 0 12px;color:#222}
    .btn{margin:6px;padding:10px 16px;font-size:16px;border:none;border-radius:10px;background:var(--brand);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .btn:active{transform:translateY(1px)}
    .btn.sub{background:#6c757d}
    .btn.ok{background:var(--ok)}
    .card{max-width:480px;margin:8px auto;background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);text-align:left}
    video{width:100%;max-width:480px;border-radius:10px;background:#000}
    #status{margin-top:8px;color:#c0392b}
    #serial{margin-top:6px;color:var(--ok);font-weight:600}
    #top{display:block}
    #scanner{display:none}
    /* iOSã®ç°¡æ˜“ãƒ©ã‚¤ãƒˆï¼ˆå…¨ç”»é¢ç™½ï¼‰ */
    #whiteTorch{display:none;position:fixed;inset:0;background:#fff;z-index:9999}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  </style>
</head>
<body>
  <div id="top">
    <h1>ç‚¹æ¤œè€…ã‚’é¸æŠ</h1>
    <div class="card" style="text-align:center">
      <button class="btn" onclick="startScan('ç¾½æŸ“')">ç¾½æŸ“</button>
      <button class="btn" onclick="startScan('æ¢…åŸ')">æ¢…åŸ</button>
      <button class="btn" onclick="startScan('æ˜ç”°å·')">æ˜ç”°å·</button>
      <button class="btn" onclick="startScan('å±±å£')">å±±å£</button>
      <button class="btn" onclick="startScan('ä½è—¤')">ä½è—¤</button>

      <div style="margin-top:10px">
        <button class="btn sub" onclick="showHistory()">å±¥æ­´ã‚’è¦‹ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="scanner">
    <div id="whiteTorch" onclick="fakeTorch(false)"></div>

    <div class="card">
      <div class="toolbar">
        <button id="btnTorch" class="btn sub" style="display:none" onclick="onTorchClick()">ğŸ”¦ ãƒ©ã‚¤ãƒˆ</button>
        <button class="btn sub" onclick="manualEntry()">QRèª­ã‚ãªã„â†’æ‰‹å…¥åŠ›</button>
      </div>

      <video id="video" autoplay playsinline></video>
      <div id="status">QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„â€¦</div>
      <div id="serial"></div>
    </div>
  </div>

<script>
/** ====== è¨­å®š ====== */
// å¹´ â†’ è¨˜å·ï¼ˆä¾‹ï¼š24å¹´â†’Lã€25å¹´â†’Mï¼‰ã€‚åˆ†ã‹ã‚Šæ¬¡ç¬¬ã“ã“ã«è¿½è¨˜ã€‚
const yearToLetter = { '24':'L', '25':'M' };
const FORM_URL_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSchpdG2NLN2uV5yAxyZC-k_xhFyem_KQDrhNmTMEGJGnsu13A/viewform";
const ENTRY_SERIAL   = "entry.797900650"; // è£½é€ ç•ªå·
const ENTRY_INSPECT  = "entry.983313981"; // ç‚¹æ¤œè€…

/** ====== å¤‰æ•° ====== */
let inspector='', codeReader;
let streamTrack=null;             // ç¾åœ¨ã®ã‚«ãƒ¡ãƒ©ãƒˆãƒ©ãƒƒã‚¯ï¼ˆtorchåˆ¶å¾¡ã«ä½¿ç”¨ï¼‰
let torchSupported=false;         // ã“ã®ç«¯æœ«/ã‚«ãƒ¡ãƒ©ã§ãƒã‚¤ãƒ†ã‚£ãƒ–torchãŒä½¿ãˆã‚‹ã‹
let isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

/** ====== ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ ====== */
function startScan(name){
  inspector = name;
  document.getElementById('top').style.display='none';
  document.getElementById('scanner').style.display='block';

  codeReader = new ZXing.BrowserMultiFormatReader();
  const vid = document.getElementById('video');

  // ZXing ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é–‹ã‹ã›ã‚‹ï¼ˆèƒŒé¢ã‚«ãƒ¡ãƒ©æŒ‡å®šï¼‰
  codeReader.decodeOnceFromConstraints({ video:{ facingMode:'environment' } }, vid)
  .then(res => {
    const raw = res.getText();
    const formatted = parseSerial(raw); // å¤‰æ›
    document.getElementById('serial').textContent = 'èª­ã¿å–ã‚Š: ' + formatted;
    saveHistory(formatted);
    openForm(formatted);               // iOSã¯åŒã‚¿ãƒ–ã€ãã‚Œä»¥å¤–ã¯åˆ¥ã‚¿ãƒ–
    cleanupStream();
    // iOS åŒã‚¿ãƒ–é·ç§»ã®ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰ã¯ä¸è¦ã€‚Android/PCã¯2ç§’å¾Œãƒªã‚»ãƒƒãƒˆã€‚
    if(!isiOS){ setTimeout(() => location.reload(), 2000); }
  })
  .catch(err => {
    document.getElementById('status').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err;
  });

  // å°‘ã—å¾…ã£ã¦ video ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒä¹—ã£ãŸå¾Œã« torch å¯å¦ã‚’åˆ¤å®š
  setTimeout(() => {
    try{
      const v = document.getElementById('video');
      const track = v.srcObject && v.srcObject.getVideoTracks ? v.srcObject.getVideoTracks()[0] : null;
      if(track){
        streamTrack = track;
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        torchSupported = !!caps.torch && !isiOS; // iOSã¯ä»•æ§˜ä¸Šãƒˆãƒ¼ãƒä¸å¯
        const btn = document.getElementById('btnTorch');
        if(torchSupported){
          btn.style.display = 'inline-block';
          btn.textContent = 'ğŸ”¦ ãƒ©ã‚¤ãƒˆ ON/OFF';
        }else if(isiOS){
          // iOSã¯ç°¡æ˜“ãƒ©ã‚¤ãƒˆï¼ˆç™½ç”»é¢ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹ãƒœã‚¿ãƒ³ã«ã™ã‚‹
          btn.style.display = 'inline-block';
          btn.textContent = 'ğŸ’¡ ç”»é¢ãƒ©ã‚¤ãƒˆ';
        }else{
          btn.style.display = 'none';
        }
      }
    }catch(e){ /* ignore */ }
  }, 600);
}

/** ====== ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ãï¼ˆiOSã¯åŒã‚¿ãƒ–ã§é·ç§»ï¼‰ ====== */
function openForm(serial){
  const url = `${FORM_URL_BASE}?usp=pp_url&${ENTRY_SERIAL}=${encodeURIComponent(serial)}&${ENTRY_INSPECT}=${encodeURIComponent(inspector)}`;
  if(isiOS){
    // Safariã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯å›é¿ï¼šåŒã˜ã‚¿ãƒ–ã§é·ç§»
    window.location.href = url;
  }else{
    window.open(url, '_blank');
  }
}

/** ====== ãƒ©ã‚¤ãƒˆãƒœã‚¿ãƒ³ã®å‹•ä½œ ====== */
function onTorchClick(){
  if(torchSupported && streamTrack){
    // ãƒã‚¤ãƒ†ã‚£ãƒ–torchï¼ˆAndroidç­‰ï¼‰
    const settings = streamTrack.getSettings ? streamTrack.getSettings() : {};
    const isOn = settings.torch === true;
    streamTrack.applyConstraints({ advanced:[{ torch: !isOn }] }).catch(()=>{});
  }else if(isiOS){
    // iOS ã¯ç°¡æ˜“ãƒ©ã‚¤ãƒˆï¼ˆå…¨ç”»é¢ç™½ã‚’è¢«ã›ã‚‹ï¼‰
    const shown = document.getElementById('whiteTorch').style.display === 'block';
    fakeTorch(!shown);
  }
}
function fakeTorch(on){
  const w = document.getElementById('whiteTorch');
  w.style.display = on ? 'block' : 'none';
}

/** ====== æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ ====== */
function manualEntry(){
  const url = `${FORM_URL_BASE}?usp=pp_url&${ENTRY_INSPECT}=${encodeURIComponent(inspector)}`;
  if(isiOS){ window.location.href = url; } else { window.open(url,'_blank'); }
}

/** ====== å±¥æ­´ ====== */
function saveHistory(serial){
  const hist = JSON.parse(localStorage.getItem('history')||'[]');
  hist.unshift({time:new Date().toLocaleString(), serial, inspector});
  localStorage.setItem('history', JSON.stringify(hist.slice(0,500)));
}
function showHistory(){
  const hist = JSON.parse(localStorage.getItem('history')||'[]');
  alert(hist.map(h=>`${h.time}  ${h.inspector}  ${h.serial}`).join('\n')||'å±¥æ­´ãªã—');
}

/** ====== å¾Œå§‹æœ« ====== */
function cleanupStream(){
  try{
    codeReader && codeReader.reset();
  }catch(e){}
  try{
    const v = document.getElementById('video');
    const tracks = v.srcObject && v.srcObject.getVideoTracks ? v.srcObject.getVideoTracks() : [];
    tracks.forEach(t => t.stop());
  }catch(e){}
}

/** ====== å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ ======
 * 1) ãƒ‘ãƒãƒ³ã‚³ï¼ˆP/M å§‹ã¾ã‚Šï¼‰: å…ˆé ­(P|M), 2, ãƒ¡ãƒ¼ã‚«ãƒ¼2å­—, å¹´(2æ¡), â€¦, æœ«å°¾6æ¡ãŒè£½é€ ç•ªå·
 *    - å¹´â†’è¨˜å·: yearToLetterï¼ˆä¾‹ 24:L, 25:Mï¼‰
 *    - ã‚¹ãƒãƒ‘ãƒ(M)ã¯è£½é€ ç•ªå·ã®å‰ã« 'M' ã‚’ä»˜åŠ 
 * 2) ã‚¹ãƒ­ãƒƒãƒˆï¼ˆæ—¥å·¥çµ„ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¾‹ï¼‰: ^[A-Z0-9]{2}([A-Z]{2})\d{9}$
 *    - ä¾‹: C0DA230008944 â†’ DA-K C008944
 *    - ãƒ¡ãƒ¼ã‚«ãƒ¼ã”ã¨ã®ã‚¯ãƒ©ã‚¹è¨˜å·ã¯ classMap ã§ç®¡ç†
 * 3) ã‚¹ãƒ­ãƒƒãƒˆï¼ˆæ—¥é›»å”ãªã© â€œäººãŒèª­ã‚€ç•ªå·â€ï¼‰: åŸæ–‡ã®ã¾ã¾
 */
function parseSerial(t){
  if(!t) return t;

  // 1) ãƒ‘ãƒãƒ³ã‚³ï¼ˆP/Mï¼‰
  const mPachi = /^([PM])2([A-Z]{2})(\d{2})\d+$/i.exec(t);
  if (mPachi){
    const head  = mPachi[1].toUpperCase();   // 'P' or 'M'
    const maker = mPachi[2].toUpperCase();   // 'DL','DT','SA'...
    const yy    = mPachi[3];                 // '24','25' ãªã©
    const tail6 = t.slice(-6);               // æœ«å°¾6æ¡
    const hyphenLetter = yearToLetter[yy] || '?';       // å¹´ã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œ
    const numPrefix = (head === 'M') ? 'M' : '';        // ã‚¹ãƒãƒ‘ãƒã¯æ•°å­—å‰ã« 'M'
    return `${maker}-${hyphenLetter} ${numPrefix}${tail6}`;
  }

  // 2) ã‚¹ãƒ­ãƒƒãƒˆï¼ˆæ—¥å·¥çµ„ï¼‰
  const mSlotNikkou = /^[A-Z0-9]{2}([A-Z]{2})\d{9}$/i.exec(t);
  if (mSlotNikkou){
    const maker = mSlotNikkou[1].toUpperCase(); // 'DA','MZ','BB' etc.
    const prefixLetter = t[0].toUpperCase();    // ä¾‹: C / K ãªã©ï¼ˆç•ªå·ã®å…ˆé ­ã«ä»˜ãï¼‰
    const tail6 = t.slice(-6);
    const classMap = { DA:'K', MZ:'J', BB:'L' }; // æ—¢çŸ¥ã®å‰²å½“ã€‚å¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µ
    const cls = classMap[maker] || 'K';
    return `${maker}-${cls} ${prefixLetter}${tail6}`;
  }

  // 3) ãã‚Œä»¥å¤–ï¼ˆã‚¹ãƒ­æ—¥é›»å”ç­‰ï¼‰ã¯åŸæ–‡ã®ã¾ã¾
  return t;
}
</script>
</body>
</html>
